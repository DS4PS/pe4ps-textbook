library( dplyr )



#############################
#############################
#############################


n <- 100

gpa <- sample( seq( 2, 4, 0.1 ), n, replace=T )
# gpa <- rnorm( n, 3.0, 0.6 ) %>% round( 1 )
# gpa[ gpa > 4 ] <- 4
# gpa[ gpa < 2 ] <- 2

lsat <- sample( 120:180, n, replace=T )
# lsat <- rnorm( n, 140, 25 ) %>% round( 0 )
# lsat[ lsat > 180 ] <- 180 - rbinom( sum( lsat > 180 ), 10, 0.25 ) 
# lsat[ lsat < 110 ] <- 110 + rbinom( sum( lsat < 100 ), 10, 0.25 ) 

z.gpa <- gpa / max( gpa )
z.lsat <- lsat / max( lsat )
max.z <- max( z.gpa ) + max( z.lsat )

p.kaplan <- ( ( z.gpa + z.lsat  ) / 2 ) ^ 5
hist( p.kaplan, col="gray" )
kaplans <- rbinom( n, 1, p.kaplan ) 
mean( kaplans )

p.admit <- ( ( z.gpa + z.lsat ) / 2 ) ^ 5
hist( p.admit )
admit <-  rbinom( n, 1, p.admit ) 
mean( admit )

cor( p.admit, p.kaplan )

gpa <- gpa+rnorm(n,0,0.1)
lsat <- lsat+rnorm(n,0,0.1)

# > dput(gpa)
gpa <- 
c(2.6159787901946, 3.21736812236511, 3.5405463872337, 3.91970108539356, 
2.03511472781177, 2.68532174464602, 2.28188577528272, 3.08720640268527, 
3.48284146544279, 3.22380189104055, 3.30665435896137, 3.32780850423293, 
3.63068142350387, 3.83636515392655, 3.05930145996071, 3.84185246439118, 
2.5851924685327, 2.00855552381307, 2.79299048387649, 2.70916293710547, 
3.81917149760915, 3.6228595647663, 2.02911531212327, 4.06257304112354, 
3.31000053524501, 2.24801764007312, 3.21803571258973, 2.88121994382121, 
3.28149707848388, 3.37537264518966, 2.06694528290228, 2.8341656291009, 
2.67077874220602, 2.99320790449838, 3.62199372770993, 2.41017136636896, 
2.48878104071005, 1.94074545589611, 2.06551642414302, 3.00895809303604, 
3.17268682678355, 3.63900386751848, 1.95564219272312, 2.90445155197373, 
2.96985021333923, 2.04184280729974, 3.51497964386235, 3.44927166080488, 
2.32360299429693, 3.62939363940064, 2.67644331229011, 3.9625794083367, 
3.78254297208907, 2.65219077868443, 2.04978651754732, 4.14464452793737, 
2.48963425316853, 3.87916927405778, 2.27686723428854, 3.2758285853739, 
2.25702120670263, 2.22312919313002, 1.90659155192284, 2.7412970195498, 
2.05778186661082, 2.32975939146246, 3.97168731681461, 2.19218613139104, 
3.64476468242825, 2.44186660097907, 2.18107385074341, 2.56219410820381, 
3.7841979264117, 3.71822022692478, 4.11113336088402, 3.12366098811401, 
2.60484367948823, 3.44220105531685, 2.87896437353783, 3.25610482267806, 
2.88243076763779, 2.9046920441307, 2.35062220472042, 2.18646903048459, 
3.34780158776369, 1.98127124131876, 3.35514639143928, 3.45353594577433, 
3.49068473784773, 2.0978658668199, 2.8337986455381, 3.3948034778424, 
3.9917474339063, 2.17246398713074, 2.46460939967413, 2.66652609693591, 
3.47013062349409, 2.65792960385949, 2.71760079662088, 2.05328463950335
)
# > dput(lsat)
lsat <- 
c(145.952300905935, 164.888289647179, 159.910726683132, 129.970164649436, 
166.887384502726, 176.082647938974, 126.107126639122, 138.122725198303, 
175.01429450674, 124.198774814702, 148.157905651809, 165.902042918279, 
170.86210876751, 129.99790831433, 158.942759642743, 144.08190941799, 
157.928700436461, 127.061252394214, 127.976715835044, 143.977311018364, 
168.106455706551, 153.055960309505, 129.064444014144, 175.849294786817, 
158.727197609528, 120.151646259827, 140.020994141552, 120.91269127151, 
144.065689775316, 166.973298192915, 156.958358920427, 155.027941726026, 
141.951051458246, 133.161455824508, 167.033654426077, 136.925631393548, 
155.958900412229, 173.109818741141, 167.154034182213, 179.02157657656, 
131.002511364673, 120.050625056506, 134.837196550179, 145.944899668184, 
120.95292452038, 123.038299671817, 175.857511479449, 124.055513940446, 
129.064654266376, 160.908015210708, 128.862085689755, 122.076773077479, 
147.898610773285, 134.045987415308, 159.03168608195, 157.004128686876, 
173.101477346685, 140.034635459666, 154.128716946311, 152.00978239957, 
129.985348798586, 154.973056993292, 134.992192179686, 129.855955393512, 
167.006113927053, 173.073118368711, 171.768836785606, 151.123510536061, 
143.107434454865, 129.001508432487, 143.018432642471, 171.956900333934, 
132.955417572184, 152.919779850605, 145.042058294691, 174.016230162574, 
178.881300588744, 140.008999177798, 153.04453474676, 174.0134253414, 
136.101729739799, 175.950286787161, 165.917359624194, 129.991254750415, 
121.055826911114, 161.95634242456, 123.067521423418, 169.012586453432, 
178.970514980657, 177.055312739649, 120.009700877406, 151.926746758908, 
173.993404666208, 120.944944607453, 150.032393136119, 170.036478709669, 
151.184419758293, 137.937387497094, 156.080379871703, 166.978991885011
)

# > dput( kaplans )
kaplans <- 
c(0L, 1L, 0L, 1L, 0L, 1L, 0L, 1L, 1L, 0L, 0L, 0L, 1L, 0L, 0L, 
1L, 0L, 0L, 1L, 0L, 1L, 1L, 0L, 1L, 0L, 0L, 0L, 0L, 0L, 1L, 0L, 
0L, 0L, 0L, 1L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 
0L, 0L, 1L, 0L, 0L, 1L, 0L, 0L, 1L, 1L, 1L, 0L, 1L, 0L, 0L, 0L, 
1L, 0L, 0L, 1L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 1L, 1L, 1L, 0L, 1L, 
1L, 0L, 0L, 1L, 0L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 1L, 0L, 0L, 0L, 
0L, 0L, 0L, 0L, 0L)

# > dput( p.kaplan )
p.kaplan <- 
c(0.193923781681413, 0.47287683402821, 0.580478841925711, 0.413573803803523, 
0.205863521749613, 0.33620535123994, 0.142167388899611, 0.275947743690683, 
0.729335627644695, 0.231615242003094, 0.384288947726956, 0.516397819885138, 
0.734503955800836, 0.445348122867454, 0.397796892728336, 0.449568532253992, 
0.264307623286641, 0.0895984671123723, 0.210941655993544, 0.221503081065662, 
0.801763427100846, 0.449937031031123, 0.0846919384681651, 0.899870172386177, 
0.495945430765638, 0.0762781307879699, 0.30977838541748, 0.168657656768907, 
0.358988800107053, 0.524681886185771, 0.154763835706046, 0.271489477091039, 
0.179343048977632, 0.213061554138318, 0.646570697736474, 0.162364557010663, 
0.215607428515951, 0.211949016414052, 0.205863521749613, 0.550607101745605, 
0.263585866144653, 0.322987558879105, 0.0969765195678889, 0.293976742403956, 
0.168657656768907, 0.0736850764950737, 0.64706351074539, 0.251671040958826, 
0.114109734036, 0.631683516595536, 0.16548717687838, 0.420162554416107, 
0.553428940948012, 0.199341375483122, 0.161144999013057, 0.728251275134177, 
0.319048390235219, 0.523432545012868, 0.190377970505028, 0.381212060912859, 
0.116591096734163, 0.162691016253755, 0.0969765195678889, 0.184433131744098, 
0.205863521749613, 0.271981974879125, 0.849684562337091, 0.15003538549689, 
0.475760689724168, 0.114109734036, 0.152967182354891, 0.313487770300792, 
0.374162267925612, 0.558011726542901, 0.607169458522428, 0.508625198954204, 
0.412025484313965, 0.390502324059283, 0.332571518640745, 0.627583881763466, 
0.190007765521348, 0.454563689105695, 0.259763075741113, 0.105813402280968, 
0.25857759453476, 0.186884216928093, 0.247073173801597, 0.622549043215077, 
0.677187080078125, 0.248445417988065, 0.137750350183543, 0.410995850132668, 
0.87448939300524, 0.0865491471428936, 0.20943780051436, 0.35378836858, 
0.435384265262225, 0.197522230053406, 0.276446699791544, 0.188808574796188
)



# > dput( admit )
admit <- 
c(0L, 1L, 0L, 1L, 0L, 1L, 0L, 1L, 1L, 0L, 0L, 1L, 1L, 0L, 1L, 
1L, 0L, 0L, 0L, 0L, 1L, 1L, 0L, 1L, 1L, 0L, 1L, 0L, 0L, 1L, 0L, 
0L, 1L, 0L, 1L, 0L, 1L, 0L, 0L, 1L, 0L, 0L, 0L, 1L, 1L, 0L, 0L, 
0L, 0L, 0L, 0L, 1L, 0L, 0L, 0L, 1L, 1L, 0L, 0L, 1L, 0L, 0L, 0L, 
0L, 0L, 0L, 1L, 0L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 1L, 1L, 0L, 1L, 
1L, 0L, 1L, 0L, 1L, 1L, 0L, 0L, 1L, 1L, 0L, 1L, 1L, 0L, 0L, 0L, 
0L, 0L, 1L, 0L, 0L)

# > dput( p.admit )
p.admit <- 
c(0.193923781681413, 0.47287683402821, 0.580478841925711, 0.413573803803523, 
0.205863521749613, 0.33620535123994, 0.142167388899611, 0.275947743690683, 
0.729335627644695, 0.231615242003094, 0.384288947726956, 0.516397819885138, 
0.734503955800836, 0.445348122867454, 0.397796892728336, 0.449568532253992, 
0.264307623286641, 0.0895984671123723, 0.210941655993544, 0.221503081065662, 
0.801763427100846, 0.449937031031123, 0.0846919384681651, 0.899870172386177, 
0.495945430765638, 0.0762781307879699, 0.30977838541748, 0.168657656768907, 
0.358988800107053, 0.524681886185771, 0.154763835706046, 0.271489477091039, 
0.179343048977632, 0.213061554138318, 0.646570697736474, 0.162364557010663, 
0.215607428515951, 0.211949016414052, 0.205863521749613, 0.550607101745605, 
0.263585866144653, 0.322987558879105, 0.0969765195678889, 0.293976742403956, 
0.168657656768907, 0.0736850764950737, 0.64706351074539, 0.251671040958826, 
0.114109734036, 0.631683516595536, 0.16548717687838, 0.420162554416107, 
0.553428940948012, 0.199341375483122, 0.161144999013057, 0.728251275134177, 
0.319048390235219, 0.523432545012868, 0.190377970505028, 0.381212060912859, 
0.116591096734163, 0.162691016253755, 0.0969765195678889, 0.184433131744098, 
0.205863521749613, 0.271981974879125, 0.849684562337091, 0.15003538549689, 
0.475760689724168, 0.114109734036, 0.152967182354891, 0.313487770300792, 
0.374162267925612, 0.558011726542901, 0.607169458522428, 0.508625198954204, 
0.412025484313965, 0.390502324059283, 0.332571518640745, 0.627583881763466, 
0.190007765521348, 0.454563689105695, 0.259763075741113, 0.105813402280968, 
0.25857759453476, 0.186884216928093, 0.247073173801597, 0.622549043215077, 
0.677187080078125, 0.248445417988065, 0.137750350183543, 0.410995850132668, 
0.87448939300524, 0.0865491471428936, 0.20943780051436, 0.35378836858, 
0.435384265262225, 0.197522230053406, 0.276446699791544, 0.188808574796188
)



gpa[ c(56,75) ] <- 4

border <- ifelse( kaplans==1, "darkorchid4", "gray" )
background <- ifelse( admit==1, "forestgreen", "gray" )


plot( gpa, lsat, 
      pch=21, cex=3, bty="n", 
      col=border, bg=adjustcolor( background, alph=0.4),
      xlab="GPA", ylab="LSAT", lwd=2  )

ids <- identify( gpa, lsat )

twins <- c(3,4,8,9,14,22,27,30,32,40,47,50,51,
           64,67,72,74,79,82,88,92,93,96,97)

plot( gpa[twins], lsat[twins], pch=21, cex=3.5, bty="n", 
      col=border[pairs], 
      bg=adjustcolor( background[pairs], alph=0.4),
      xlab="GPA", ylab="LSAT", lwd=2,
      xlim=c(2,4), ylim=c(120,180) )

matched.kaplans <- kaplans[ twins ]
matched.admit <- admit[ twins ]
matched.gpa <- gpa[ twins ]
matched.lsat <- lsat[ twins ]

summary( lm( admit ~ gpa + lsat + kaplans ) )
summary( lm( matched.admit ~ matched.gpa + 
               matched.lsat + matched.kaplans ) )


dput( round( gpa, 1 ) )
dput( round( lsat, 0 ) )


# >  dput( round( gpa, 1 ) )
gpa <-
c(2.6, 3.2, 3.5, 3.9, 2, 2.7, 2.3, 3.1, 3.5, 3.2, 3.3, 3.3, 3.6, 
3.8, 3.1, 3.8, 2.6, 2, 2.8, 2.7, 3.8, 3.6, 2, 4.1, 3.3, 2.2, 
3.2, 2.9, 3.3, 3.4, 2.1, 2.8, 2.7, 3, 3.6, 2.4, 2.5, 1.9, 2.1, 
3, 3.2, 3.6, 2, 2.9, 3, 2, 3.5, 3.4, 2.3, 3.6, 2.7, 4, 3.8, 2.7, 
2, 4.1, 2.5, 3.9, 2.3, 3.3, 2.3, 2.2, 1.9, 2.7, 2.1, 2.3, 4, 
2.2, 3.6, 2.4, 2.2, 2.6, 3.8, 3.7, 4.1, 3.1, 2.6, 3.4, 2.9, 3.3, 
2.9, 2.9, 2.4, 2.2, 3.3, 2, 3.4, 3.5, 3.5, 2.1, 2.8, 3.4, 4, 
2.2, 2.5, 2.7, 3.5, 2.7, 2.7, 2.1)

# > dput( round( lsat, 0 ) )
lsat <- 
c(146, 165, 160, 130, 167, 176, 126, 138, 175, 124, 148, 166, 
171, 130, 159, 144, 158, 127, 128, 144, 168, 153, 129, 176, 159, 
120, 140, 121, 144, 167, 157, 155, 142, 133, 167, 137, 156, 173, 
167, 179, 131, 120, 135, 146, 121, 123, 176, 124, 129, 161, 129, 
122, 148, 134, 159, 157, 173, 140, 154, 152, 130, 155, 135, 130, 
167, 173, 172, 151, 143, 129, 143, 172, 133, 153, 145, 174, 179, 
140, 153, 174, 136, 176, 166, 130, 121, 162, 123, 169, 179, 177, 
120, 152, 174, 121, 150, 170, 151, 138, 156, 167)





panel.cor <- function(x, y, digits=2, prefix="", cex.cor)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y))
    txt <- format(c(r, 0.123456789), digits=digits)[1]
    txt <- paste(prefix, txt, sep="")
    if(missing(cex.cor)) cex <- 0.8/strwidth(txt)
    
    test <- cor.test(x,y)
    # borrowed from printCoefmat
    Signif <- symnum(test$p.value, corr = FALSE, na = FALSE,
                  cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
                  symbols = c("***", "**", "*", ".", " "))
    
    text(0.5, 0.5, txt, cex = 1.5 )
    text(.7, .8, Signif, cex=cex, col=2)
}

panel.smooth <- function (x, y, col = par("col"), bg = NA, pch = par("pch"), 
    cex = 0.5, col.smooth = "red", span = 2/3, iter = 3, ...) 
{
    points(x, y, pch = 19, col = gray(0.7,0.2), bg = bg, cex = cex)
    ok <- is.finite(x) & is.finite(y)
    if (any(ok)) 
        lines(stats::lowess(x[ok], y[ok], f = span, iter = iter), 
            col = col.smooth, lwd=2, ...)
}

# custom plot
jplot <- function( x1, x2, lab1="", lab2="", draw.line=T, ... )
{

    plot( x1, x2,
          pch=19, 
          col=gray(0.6, alpha = 0.2), 
          cex=0.5,  
          bty = "n",
          xlab=lab1, 
          ylab=lab2, cex.lab=1.5,
        ... )

    if( draw.line==T ){ 
        ok <- is.finite(x1) & is.finite(x2)
        lines( lowess(x2[ok]~x1[ok]), col="red", lwd=3 ) }

}



